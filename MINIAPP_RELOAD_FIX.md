# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫ Mini App

## –ü—Ä–æ–±–ª–µ–º—ã

1. ‚ùå **–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã** - –∫–∞–∂–¥—ã–µ 1-2 —Å–µ–∫—É–Ω–¥—ã
2. ‚ùå **–°–µ—Å—Å–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** - `auth_user` –≤—Å–µ–≥–¥–∞ `null`
3. ‚ùå **–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Å—Å–∏–π –¥–ª—è Telegram Mini App

**–§–∞–π–ª: `.env`**
```env
SESSION_SECURE_COOKIE=true
SESSION_DOMAIN=.sticap.ru
SESSION_SAME_SITE=none
SANCTUM_STATEFUL_DOMAINS=tg.sticap.ru
```

**–§–∞–π–ª: `config/session.php`**
```php
'same_site' => env('SESSION_SAME_SITE', 'none'),
```

### 2. –õ–æ–≥–∏–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–§–∞–π–ª: `app/Http/Controllers/MiniAppController.php`**

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `Auth::check()` –≤ –º–µ—Ç–æ–¥–µ `index()`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `Auth::check()` –≤ –º–µ—Ç–æ–¥–µ `auth()`
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ `initData` –¥–ª—è —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 3. Frontend - —É–±—Ä–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞

**–§–∞–π–ª: `resources/views/miniapp/app.blade.php`**

- ‚úÖ –£–±—Ä–∞–Ω–∞ —Å—Ç—Ä–æ–∫–∞ `window.location.reload()` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `authInProgress` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è

```bash
# 1. –õ–æ–∫–∞–ª—å–Ω–æ –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
git add .
git commit -m "Fix: Infinite reloads in Mini App - session config and auth logic"
git push origin main

# 2. –ù–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ
cd /path/to/project
git pull origin main

# 3. –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à–∏
php artisan config:clear
php artisan view:clear
php artisan cache:clear

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä
sudo systemctl reload nginx
# –∏–ª–∏ 
sudo systemctl reload apache2
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

1. **–û—Ç–∫—Ä—ã—Ç—å Mini App —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞**
2. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–π—Ç–∏ –æ–¥–∏–Ω —Ä–∞–∑** 
3. **–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥**
4. **–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:** `"User already authenticated, skipping initData processing"`

## –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```
[INFO] Mini App accessed {"has_init_data":true,"auth_user":1107317588}
[INFO] User already authenticated, skipping initData processing
```

**–í–º–µ—Å—Ç–æ:**
```
[INFO] Mini App accessed {"has_init_data":false,"auth_user":null}
[WARNING] Web App data verification failed
[INFO] Temporarily allowing unverified Web App data for testing
[INFO] User updated via Mini App
```

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï:** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Å—Å–∏–∏ `SESSION_SAME_SITE=none` –∏ `SESSION_SECURE_COOKIE=true` –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ Telegram Mini App, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ iframe —Å –¥—Ä—É–≥–æ–≥–æ –¥–æ–º–µ–Ω–∞.

üîß **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (DevTools > Application > Cookies), —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–∏ –∫—É–∫–∏ —Å–µ—Å—Å–∏–∏ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.

üìù **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ `/miniapp` –¥–æ–ª–∂–Ω–æ —Ä–µ–∑–∫–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å—Å—è.
